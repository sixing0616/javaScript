<html>
<head>
  <title>Evernote Export</title>
  <basefont face="楷体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/268868 (zh-CN); Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: 楷体;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="1101"/>
<h1>1 反向Ajax基础知识</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="margin-left:21.2500pt; text-indent:-21.2500pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">1. 什么是反向ajax</font></p><div><font color="#E30000">     反向Ajax（Reverse Ajax）本质上则是这样的一种概念：能够从服务器端向客户端发送数据。在一个标准的HTTP Ajax请求中，数据是发送给服务器端的，反向Ajax可以某些特定的方式来模拟发出一个Ajax请求，这些方式本文都会论及，这样的话，服务器就可以尽可能快地向客户端发送事件（低延迟通信）。</font></div><div><font color="#E30000"><br></font></div><p style="margin-left:21.2500pt; text-indent:-21.2500pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">2. 反向ajax的目的</font></p><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">反向Ajax的目的是允许服务器端向客户端推送信息。Ajax请求在缺省情况下是无状态的，且只能从客户端向服务器端发出请求。你可以通过使用技术模拟服务器端和客户端之间的响应式通信来绕过这一限制。</font></p><div><font color="#E30000"><br></font></div><div><font color="#E30000">3. 为什么使用反向ajax</font></div><div>   <span style="color: rgb(227, 0, 0);">web</span><font style="color: rgb(227, 0, 0);">开发在过去的几年中有了很大的进展，我们已经远超了把静态网页链接在一起的做法，这种做法会引起浏览器的刷新，并且要等待页面的加载。现在需要的是能够通过</font><font style="color: rgb(227, 0, 0);">web</font><font style="color: rgb(227, 0, 0);">来访问的完全动态的应用，这些应用通常需要尽可能的快，提供近乎实时的组件。</font></div><div><font style="color: rgb(227, 0, 0);"><br></font></div><div><img src="反向Ajax_files/Image.png" type="image/png" style="cursor: default;"/></div></div>
</div>
<hr>
<a name="1288"/>
<h1>2 模拟反向ajax</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><font color="#E30000">test.js</font><div style="font-size: 13px;"><font color="#6A0081" face="Courier New">window.onload=function(){<br>
    document.getElementById(&quot;ok&quot;).onclick=function(){<br>
          //setInterval()中的第二个参数是周期。在第一次调用后，会自动按照周期来执行指定函数<br>
          t = setInterval(&quot;revAjax()&quot;,1000);<br>
     };    <br>
    <br>
     document.getElementById(&quot;cancel&quot;).onclick=function(){<br>
//          clearTimeout(t);<br>
          clearInterval(t);<br>
     }<br>
    <br>
}<br><br>
var t;<br><br>
function revAjax(){<br>
     var xmlHttp=ajaxFunction();<br><br>
     xmlHttp.onreadystatechange=function(){<br>
          if(xmlHttp.readyState==4){<br>
               if(xmlHttp.status==200||xmlHttp.status==304){<br>
                    var data = xmlHttp.responseText;<br>
                   <br>
                    document.getElementById(&quot;showtime&quot;).innerHTML = &quot;&lt;h1&gt;&quot;+data+&quot;&lt;/h1&gt;&quot;;<br>
                   <br>
               }<br>
          }<br>
     } <br><br>
     xmlHttp.open(&quot;get&quot;,&quot;timeServlet?timeStamp=&quot;+new Date().getTime(),true);<br><br>
     xmlHttp.send(null);<br>
    <br>
//     t = setTimeout(revAjax,1000);<br>
    <br>
}<br><br>
function ajaxFunction(){<br>
   var xmlHttp;<br>
   try{ // Firefox, Opera 8.0+, Safari<br>
        xmlHttp=new XMLHttpRequest();<br>
    }<br>
    catch (e){<br>
        try{// Internet Explorer<br>
              xmlHttp=new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);<br>
           }<br>
         catch (e){<br>
           try{<br>
              xmlHttp=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);<br>
           }<br>
           catch (e){}<br>
           }<br>
    }<br>
     return xmlHttp;<br>
}<br></font></div><div><br></div><div><font color="#E30000">testajax.jsp</font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size: 10pt;">&lt;%@</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">page</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">language</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;java&quot; </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">pageEncoding</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;utf-8&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">%&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!</span></font><font face="Courier New" size="2"><span style="font-size:10pt">DOCTYPE</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HTML</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">PUBLIC</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">html</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">head</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">    </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">script</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">type</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;./test.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">script</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">head</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">body</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">    </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">form</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">action</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">enctype</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;application/x-www-form-urlencoded&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">         </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">input</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">type</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;button&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">name</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;ok&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">id</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&quot;ok&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">value</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;显示当前时间&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">         </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">input</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">type</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;button&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">name</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;cancel&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">id</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&quot;cancel&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">value</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;停止显示&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">         </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">div</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">id</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;showtime&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">div</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">     </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">form</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">body</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font face="Courier New" size="2"><span style="font-size:10pt">html</span></font><font face="Courier New" size="2"><span style="font-size: 10pt;">&gt;</span></font></font></div><div align="left"><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div><font color="#E30000">TimeServlet.java</font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size: 10pt;"><b>public</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">TimeServlet</span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HttpServlet {</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doGet(HttpServletRequest request, HttpServletResponse response)</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">            response.setContentType(</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&quot;text/html;charset=utf-8&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            PrintWriter out = response.getWriter();</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">            SimpleDateFormat sdf =</span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">SimpleDateFormat(</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&quot;yyyy年MM月dd日      hh点mm分ss秒&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">            String time = sdf.format(</span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Date());</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            out.println(time);</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doPost(HttpServletRequest request, HttpServletResponse response)</span></font></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#6A0081"><font face="Courier New" size="2"><span style="font-size:10pt">            response.setContentType(</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&quot;text/html&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            PrintWriter out = response.getWriter();</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">            doGet(request, response);</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#6A0081" face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div></div>
</div>
<hr>
<a name="1706"/>
<h1>3 实现反向ajax</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="margin-left:28.3500pt; text-indent:-28.3500pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">1、轮询（polling）（主动式）</font></p><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">轮询（polling）涉及了从客户端向服务器端发出请求以获取一些数据，这显然就是一个纯粹的Ajax HTTP请求。为了尽快地获得服务器端事件，轮询的间隔（两次请求相隔的时间）必须尽可能地小。但有这样的一个缺点存在：如果间隔减小的话，客户端浏览器就会发出更多的请求，这些请求中的许多都不会返回任何有用的数据，而这将会白白地浪费掉带宽和处理资源。</font></p><p style="margin-left:42.0000pt; text-indent:-21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">&lt;1&gt;HTTP轮询和JSONP轮询</font></p><p style="margin-left:21.0000pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000"><img src="反向Ajax_files/Image [1].png" type="image/png" height="249" style="cursor: default;" width="314"/></font></p><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">JSONP轮询基本上与HTTP轮询一样，不同之处则是JSONP可以发出跨域请求（不是在你的域内的请求）。清单1使用JSONP来通过邮政编码获取地名，JSONP请求通常可通过它的回调参数和返回内容识别出来，这些内容是可执行的JavaScript代码。</font></p><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">用JavaScript实现的轮询的优点和缺点：</font></p><div><font color="#E30000">      1. 优点：很容易实现，不需要任何服务器端的特定功能，且在所有的浏览器上都能工作。</font></div><div><font color="#E30000">      </font><span style="color: rgb(227, 0, 0);">2. </span><font style="color: rgb(227, 0, 0);">缺点：这种方法很少被用到，因为它是完全不具伸缩性的。试想一下，在</font><font style="color: rgb(227, 0, 0);">100</font><font style="color: rgb(227, 0, 0);">个客户端每个都发出</font><font style="color: rgb(227, 0, 0);">2</font><font style="color: rgb(227, 0, 0);">秒钟的轮询请求的情况下，所损失的带宽和资源数量，在这种情况下</font><font style="color: rgb(227, 0, 0);">30%</font><font style="color: rgb(227, 0, 0);">的请求没有返回数据。</font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!--客户端代码--&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!DOCTYPE HTML PUBLIC</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;title&gt;HTTP Polling&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        jQuery(function($) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            setInterval(function() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'body'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[client] checking for events...&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                $.getJSON(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'events'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">, function(events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">(events.length) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'body'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: blue;&quot;&gt;[client] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events.length +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' events&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'body'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: red;&quot;&gt;[client] no event&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>for</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(var i in events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'body'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[event] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events[i] +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/span&gt;&lt;br/&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }, 2000);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body style=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;font-family: monospace;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">PollingServlet</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HttpServlet {</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random random =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">BlockingQueue&lt;String&gt; messages =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">LinkedBlockingQueue&lt;String&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Event generator&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">run() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>while</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!Thread.</span><span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().isInterrupted()) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>try</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>sleep</i></span><span style="font-size:10pt">(random.nextInt(5000));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(InterruptedException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                messages.offer(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;At &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Date());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    };</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">init()</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.start();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">destroy() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doGet(HttpServletRequest req, HttpServletResponse resp)</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        List&lt;String&gt; messages =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">LinkedList&lt;String&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>this</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.messages.drainTo(messages);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setStatus(HttpServletResponse.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>SC_OK</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setContentType(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;application/json&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getWriter().write(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONArray(messages).toString());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getWriter().flush();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div align="left"><div align="left"><div align="left"><font color="#E30000">&lt;2&gt;Piggyback（被动式）</font></div></div></div><div align="left"><div align="left"><div align="left"><font color="#E30000">捎带轮询（piggyback polling）是一种比轮询更加聪明的做法，因为它会删除掉所有非必需的请求（没有返回数据的那些）。不存在时间间隔，客户端在需要的时候向服务器端发送请求。不同之处在于响应的那部分上，响应被分成两个部分：对请求数据的响应和对服务器事件的响应，如果任何一部分有发生的话。</font></div></div></div><div align="left"><div align="left"><div align="left"><font color="#E30000">这种方法也有着一些优点和缺点：</font></div></div></div><div align="left"><div align="left"><div align="left"><font color="#E30000">1. 优点：没有不返回数据的请求，因为客户端对何时发送请求做了控制，对资源的消耗较少。该方法也是可用在所有的浏览器上，不需要服务器端的特殊功能。</font></div></div></div><div align="left"><div align="left"><div align="left"><font color="#E30000">2. 缺点：当累积在服务器端的事件需要传送给客户端时，你却一点都不知道，因为这需要一个客户端行为来请求它们。</font></div></div></div></blockquote><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!--客户端代码--&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!DOCTYPE HTML PUBLIC</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;</span></font><font color="#0000FF" face="Courier New" size="2"><span style="font-size:10pt"><u>http://www.w3.org/TR/html4/loose.dtd</u></span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;title&gt;HTTP Polling&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        jQuery(function($) {</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            function processEvents(events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(events.length) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: blue;&quot;&gt;[client] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events.length +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' events&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: red;&quot;&gt;[client] no event&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>for</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(var i in events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[event] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events[i] +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/span&gt;&lt;br/&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#submit'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).click(function() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[client] checking for events...&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                $.post(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'ajax'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">, function(data) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[server] form valid ? '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ data.formValid +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' &lt;/span&gt;&lt;br/&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    processEvents(data.events);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            });</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;button id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;submit&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;Submit form&lt;/button&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;div id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;logs&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">style=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;font-family: monospace;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/div&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">PiggybackServlet</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HttpServlet {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random random =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">BlockingQueue&lt;String&gt; messages =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">LinkedBlockingQueue&lt;String&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Event generator&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">run() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>while</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!Thread.</span><span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().isInterrupted()) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>try</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>sleep</i></span><span style="font-size:10pt">(random.nextInt(5000));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(InterruptedException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                messages.offer(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;At &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Date());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    };</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">init()</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.start();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">destroy() {</span></font><font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">.interrupt();}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doPost(HttpServletRequest req, HttpServletResponse resp)</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        System.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>out</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.println(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;FORM POSTED !&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        List&lt;String&gt; messages =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">LinkedList&lt;String&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>this</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.messages.drainTo(messages);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setStatus(HttpServletResponse.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>SC_OK</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setContentType(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;application/json&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>try</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            resp.getWriter().write(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONObject().put(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;events&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONArray(messages)).put(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;formValid&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>true</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">).toString());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(JSONException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throw</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException(e.getMessage(), e);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getWriter().flush();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doGet(HttpServletRequest req, HttpServletResponse resp)</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        List&lt;String&gt; messages =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">LinkedList&lt;String&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>this</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.messages.drainTo(messages);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setStatus(HttpServletResponse.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>SC_OK</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setContentType(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;application/json&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getWriter().write(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONArray(messages).toString());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getWriter().flush();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div></div><div><font color="#E30000"><font>     &lt;3&gt;</font></font><span style="text-indent: -28.35pt;"><font color="#E30000">Comet</font></span></div><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000"> 使用了轮询或是捎带的反向Ajax非常受限：其不具伸缩性，不提供低延迟通信（只要事件一到达服务器端，它们就以尽可能快的速度到达浏览器端）。Comet是一个web应用模型，在该模型中，请求被发送到服务器端并保持一个很长的存活期，直到超时或是有服务器端事件发生。在该请求完成后，另一个长生存期的Ajax请求就被送去等待另一个服务器端事件。使用Comet的话，web服务器就可以在无需显式请求的情况下向客户端发送数据。</font></p><p style="margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">Comet的一大优点是，每个客户端始终都有一个向服务器端打开的通信链路。服务器端可以通过在事件到来时立即提交（完成）响应来把事件推给客户端，或者它甚至可以累积再连续发送。因为请求长时间保持打开的状态，故服务器端需要特别的功能来处理所有的这些长生存期请求。</font></p><p style="margin-bottom:0pt; margin-top:0pt;"><font color="#E30000"><img src="反向Ajax_files/Image [2].png" type="image/png" height="360" style="cursor: default;" width="311"/></font></p><p style="margin-left:35.4500pt; text-indent:-35.4500pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">     * 流（streaming）</font></p><p style="text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000"> 在流（streaming）模式中，有一个持久连接会被打开。只会存在一个长生存期请求（图3中的#1），因为每个到达服务器端的事件都会通过这同一连接来发送。因此，客户端需要有一种方法来把通过这同一连接发送过来的不同响应分隔开来。从技术上来讲，两种常见的流技术包括Forever Iframe（隐藏的IFrame），或是被用来在JavaScript中创建Ajax请求的XMLHttpRequest对象的多部分（multi-part）特性。</font></p><p style="margin-left:42.0000pt; text-indent:-21.0000pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">     </font><span style="color: rgb(227, 0, 0); text-indent: -21pt;">* </span><span style="color: rgb(227, 0, 0); text-indent: -21pt;">Forever Iframe</span></p><p style="margin-left:21.0000pt; text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">      Forever Iframe（永存的Iframe）技术涉及了一个置于页面中的隐藏Iframe标签，该标签的src属性指向返回服务器端事件的servlet路径。每次在事件到达时，servlet写入并刷新一个新的script标签，该标签内部带有JavaScript代码，iframe的内容被附加上这一script标签，标签中的内容就会得到执行。</font></p><p style="margin-left:21.0000pt; text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">      1. 优点：实现简单，在所有支持iframe的浏览器上都可用。</font></p><p style="margin-left:21.0000pt; text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">      2. 缺点： 没有方法可用来实现可靠的错误处理或是跟踪连接的状态，因为所有的连接和数据都是由浏览器通过HTML标签来处理的，因此你没有办法知道连接何时在哪一端已被断开了。</font></p><p style="margin-left:42.0000pt; margin-bottom:0pt; margin-top:0pt;"></p><p style="margin-left:42.0000pt; text-indent:-21.0000pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">     * Multi-part XMLHttpRequest</font></p><p style="margin-left:21.0000pt; text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">     第二种技术，更可靠一些，是XMLHttpRequest对象上使用某些浏览器（比如说Firefox）支持的multi-part标志。Ajax请求被发送给服务器端并保持打开状态，每次有事件到来时，一个多部分的响应就会通过这同一连接来写入。</font></p><p style="margin-left:21.0000pt; text-indent:21.0000pt; margin-bottom:0pt; margin-top:0pt; text-align:left;"><font color="#E30000">      1. 优点：只打开了一个持久连接，这就是节省了大部分带宽使用率的Comet技术。</font></p><div><font color="#E30000">      2. <font>缺点：并非所有的浏览器都支持</font><font>multi-part</font><font>标志。某些被广泛使用的库，比如说用</font><font>Java</font><font>实现的</font><font>CometD</font><font>，被报告在缓冲方面有问题。例如，一些数据块（多个部分）可能被缓冲，然后只有在连接完成或是缓冲区已满时才被发送，而这有可能会带来比预期要高的延迟。</font></font></div><div><font color="#E30000"><font><br></font></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!--客户端代码--&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!DOCTYPE HTML PUBLIC</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;title&gt;HTTP Polling&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        jQuery(function($) {</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'XMLHttpRequest'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">in window &amp;&amp;</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'multipart'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">in window.XMLHttpRequest.prototype)) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                alert(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'Comet Http Streaming is not supported in your browser !'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throw</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Error(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'Comet Http Streaming is not supported in your browser !'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            function processEvents(events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(events.length) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: blue;&quot;&gt;[client] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events.length +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' events&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: red;&quot;&gt;[client] no event&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>for</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(var i in events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[event] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events[i] +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/span&gt;&lt;br/&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            var xhr = $.ajaxSettings.xhr();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            xhr.multipart =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>true</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            xhr.open(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'GET'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'ajax'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>true</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            xhr.onreadystatechange = function() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(xhr.readyState == 4) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    processEvents($.parseJSON(xhr.responseText));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            };</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            xhr.send(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>null</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;div id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;logs&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">style=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;font-family: monospace;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/div&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ReverseAjaxServlet</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HttpServlet {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Queue&lt;AsyncContext&gt; asyncContexts =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ConcurrentLinkedQueue&lt;AsyncContext&gt;();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">String</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">boundary</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;ABCDEFGHIJKLMNOPQRST&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// generated</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random random =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Event generator&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">run() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>while</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!Thread.</span><span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().isInterrupted()) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>try</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>sleep</i></span><span style="font-size:10pt">(random.nextInt(5000));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>for</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(AsyncContext asyncContext : asyncContexts) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        HttpServletResponse peer = (HttpServletResponse) asyncContext.getResponse();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.getOutputStream().println(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Content-Type: application/json&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.getOutputStream().println();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.getOutputStream().println(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONArray().put(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;At &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Date()).toString());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.getOutputStream().println(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;--&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">boundary</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.flushBuffer();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(InterruptedException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(IOException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throw</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">RuntimeException(e.getMessage(), e);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    };</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">init()</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.start();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">destroy() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doGet(HttpServletRequest req, HttpServletResponse resp)</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        AsyncContext asyncContext = req.startAsync();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        asyncContext.setTimeout(0);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setContentType(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;multipart/x-mixed-replace;boundary=\&quot;&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">boundary</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;\&quot;&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.setHeader(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Connection&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;keep-alive&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.getOutputStream().print(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;--&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">boundary</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resp.flushBuffer();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        asyncContexts.offer(asyncContext);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div></div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div align="left"><div align="left"><p style="margin-left:35.4500pt; text-indent:-35.4500pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">* 长轮询（long polling）</font></p></div></div></blockquote><div align="left"><div align="left"><p style="text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">长轮询（long polling）模式涉及了打开连接的技术。连接由服务器端保持着打开的状态，只要一有事件发生，响应就会被提交，然后连接关闭。接下来。一个新的长轮询连接就会被正在等待新事件到达的客户端重新打开。</font></p><p style="margin-left:42.0000pt; text-indent:-21.0000pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">* script标签</font></p><p style="margin-left: 21pt; text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">正如iframe一样，其目标是把script标签附加到页面上以让脚本执行。服务器端则会：挂起连接直到有事件发生，接着把脚本内容发送回浏览器，然后重新打开另一个script标签来获取下一个事件。</font></p><p style="margin-left: 21pt; text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">1. 优点：因为是基于HTML标签的，所有这一技术非常容易实现，且可跨域工作（缺省情况下，XMLHttpRequest不允许向其他域或是子域发送请求）。</font></p><p style="margin-left: 21pt; text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">2. 缺点：类似于iframe技术，错误处理缺失，你不能获得连接的状态或是有干涉连接的能力。</font></p><p style="margin-left:42.0000pt; margin-bottom:0pt; margin-top:0pt;"></p><p style="margin-left:42.0000pt; text-indent:-21.0000pt; margin-bottom:0pt; margin-top:0pt;"><font color="#E30000">* XMLHttpRequest长轮询</font></p><p style="margin-left: 21pt; text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">也是一种推荐的实现Comet的做法是打开一个到服务器端的Ajax请求然后等待响应。服务器端需要一些特定的功能来允许请求被挂起，只要一有事件发生，服务器端就会在挂起的请求中送回响应并关闭该请求，完全就像是你关闭了servlet响应的输出流。然后客户端就会使用这一响应并打开一个新的到服务器端的长生存期的Ajax请求。</font></p><p style="margin-left: 21pt; text-indent: 21pt; margin-bottom: 0pt; margin-top: 0pt;"><font color="#E30000">1. 优点：客户端很容易实现良好的错误处理系统和超时管理。这一可靠的技术还允许在与服务器端的连接之间有一个往返，即使连接是非持久的（当你的应用有许多的客户端时，这是一件好事）。它可用在所有的浏览器上；你只需要确保所用的XMLHttpRequest对象发送到的简单的Ajax请求就可以了。</font></p><div><font color="#E30000">      2. <font>缺点：相比于其他技术来说，不存在什么重要的缺点，像所有我们已经讨论过的技术一样，该方法依然依赖于无状态的</font><font>HTTP</font><font>连接，其要求服务器端有特殊的功能来临时挂起连接。</font></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt; background:#e8f2fe">&lt;!--客户端代码--&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!DOCTYPE HTML PUBLIC</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;title&gt;HTTP Polling&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        jQuery(function($) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            function processEvents(events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(events.length) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: blue;&quot;&gt;[client] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events.length +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' events&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span style=&quot;color: red;&quot;&gt;[client] no event&lt;/span&gt;&lt;br/&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>for</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(var i in events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'#logs'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).append(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;span&gt;[event] '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ events[i] +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/span&gt;&lt;br/&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            function long_polling() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                $.getJSON(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'ajax'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">, function(events) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    processEvents(events);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    long_polling();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            long_polling();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;div id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;logs&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">style=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;font-family: monospace;&quot;</span></font><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt">&lt;/div&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ReverseAjaxServlet</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">HttpServlet {</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Queue&lt;AsyncContext&gt; asyncContexts =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ConcurrentLinkedQueue&lt;AsyncContext&gt;();</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random random =</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Random();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>final</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Thread(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Event generator&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">run() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">           </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>while</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!Thread.</span><span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().isInterrupted()) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">               </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>try</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>sleep</i></span><span style="font-size:10pt">(random.nextInt(5000));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>while</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(!asyncContexts.isEmpty()) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        AsyncContext asyncContext = asyncContexts.poll();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        HttpServletResponse peer = (HttpServletResponse) asyncContext.getResponse();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.getWriter().write(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">JSONArray().put(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;At &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Date()).toString());</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.setStatus(HttpServletResponse.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>SC_OK</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        peer.setContentType(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;application/json&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        asyncContext.complete();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(InterruptedException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                    Thread.</span> <span style="font-size:10pt"><i>currentThread</i></span><span style="font-size:10pt">().interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>catch</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(IOException e) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throw</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>new</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">RuntimeException(e.getMessage(), e);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    };</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">init()</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.start();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">destroy() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">generator</span></font><font face="Courier New" size="2"><span style="font-size:10pt">.interrupt();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>void</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">doGet(HttpServletRequest req, HttpServletResponse resp)</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>throws</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">ServletException, IOException {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        AsyncContext asyncContext = req.startAsync();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        asyncContext.setTimeout(0);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        asyncContexts.offer(asyncContext);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div></div></div></div></div>
</div>
<hr>
<a name="1120"/>
<h1>4 pushlets框架(DWR框架)</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div align="left"><font color="#E30000">Pushlets 是一个开源的 Comet 框架, <u>Pushlets</u> 使用了观察者模型：客户端发送请求，订阅感兴趣的事件；服务器端为每个客户端分配一个会话 ID 作为标记，事件源会把新产生的事件以多播的方式发送到订阅者的事件队列里。</font></div><div align="left"><font color="#E30000">下载pushlets，官方地址：http: //www.pushlets.com/</font></div><div align="left"><font color="#E30000">搭建pushlets开发环境，演示示例：</font></div><div align="left"><font color="#E30000">创建一个web工程</font></div><div align="left"><font color="#E30000">解压缩下载的压缩包</font></div><div align="left"><font color="#E30000">将lib/pushlet.jar包复制到工程中的WEB-INF目录下的lib下</font></div><div align="left"><font color="#E30000">将 webapps\pushlet\WEB-INF\classes目录下所有properties文件复制到工程中的 WEB-INF目录下</font></div><div align="left"><font color="#E30000">将 webapps\pushlet\WEB-INF\web.xml文件的配置信息复制到工程中的 web.xml文件中</font></div><div align="left"><font color="#E30000">复制 lib目录下的ajax-pushlet-client.js文件和assets目录下的util.js文件</font></div><div align="left"><font color="#E30000">复制 example 目录下 chat相关 四个文件</font></div><div align="left"><font color="#E30000">Pushlet工作流程</font></div><div align="left"><font color="#E30000">客户端PL._init(),获取XMLHttpRequest，设置URL、状态。</font></div><div align="left"><font color="#E30000">客户端PL.joinListen (subject)，p_event=join-listen-ack，服务端加入、监听、订阅，返回p_event=refresh。</font></div><div align="left"><font color="#E30000">客户端执行refresh，服务器端读取事件，并推送至客户端。</font></div><div align="left"><font color="#E30000">客户端根据收到的事件类型，进行相关操作。</font></div><div align="left"><font color="#E30000"><br></font></div><div align="left"><font color="#E30000">客户端代码示例：</font></div><div align="left"><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;meta http-equiv=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Content-Type&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">content=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/html; charset=UTF-8&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;title&gt;编写最简单 pushlet demo&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;/ajaxweb05/ajax-pushlet-client.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!-- pushlet框架本身 不依赖 jQuery --&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;/ajaxweb05/js/jquery-1.8.3.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      $(function(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            alert(1);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 初始化 pushlet 客户端对象</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            PL._init();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// pushlet框架 采用观察者模式</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            PL.joinListen(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/money'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 服务器只要有 和 /money相关的信息，主动发给客户端</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function onData(event) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            alert(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;ok&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 获得服务器发回数据</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            var value = event.get(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testName&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#info&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).html($(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#info&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">).html() + value +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;&lt;br/&gt;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;div id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;info&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/div&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><br></font></div></div><div align="left"><div><span style="color: rgb(227, 0, 0);">服务器端代码示例：</span></div><div align="left"><font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//向 /money 主题添加事件</span></font></div><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Money</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>implements</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Serializable{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>static</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">MoneyTest</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">EventPullSource {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>int</b></span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>long</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">getSleepTime() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>return</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">60000;</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 10秒</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Event pullEvent() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 用来向主题添加事件</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  System.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>out</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.println(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;------- &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font><font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 创建/money 主题相关事件</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  Event event  = Event.createDataEvent(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;/money&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 设置事件参数  name value ，客户端通过name 获得 value</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  event.setField(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testName&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testValue&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font><font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">++);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>return</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">event;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div align="left"><font color="#E30000">向sources.properties文件中，增加自定义内容：</font></div><div align="left"><font color="#E30000">source7=app.pushlet.Money$MoneyTest</font></div><div align="left"><font color="#E30000"><br></font></div><div align="left"><font color="#E30000">web.xml</font></div><div align="left"><div align="left"><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;?</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">xml</span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">version</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;1.0&quot;</span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">encoding</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;UTF-8&quot;</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">?&gt;</span></font></div><div align="left"><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">web-app</span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">version</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;2.5&quot;</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">xmlns</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">xmlns:xsi</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#7F007F" face="Courier New" size="2"><span style="font-size:10pt">xsi:schemaLocation</span></font><font face="Courier New" size="2"><span style="font-size:10pt">=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://java.sun.com/xml/ns/javaee</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">      http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">display-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">display-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#3F5FBF" face="Courier New" size="2"><span style="font-size:10pt">&lt;!-- Define the pushlet servlet --&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">pushlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-class</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.servlet.Pushlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-class</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">load-on-startup</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">1</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">load-on-startup</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#3F5FBF" face="Courier New" size="2"><span style="font-size:10pt">&lt;!-- Define the Servlet Mappings. --&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#3F5FBF" face="Courier New" size="2"><span style="font-size:10pt">&lt;!-- The pushlet --&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-mapping</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">pushlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">url-pattern</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">/pushlet.srv</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">url-pattern</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-mapping</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">description</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">This is the description of my J2EE component</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">description</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">display-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">This is the display name of my J2EE component</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">display-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">TimeServlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-class</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">app.servlet.TimeServlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-class</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-mapping</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">TimeServlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-name</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">url-pattern</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">/timeServlet</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">url-pattern</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">servlet-mapping</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">    </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">welcome-file-list</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">welcome-file</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">index.jsp</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font> <font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">welcome-file</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"> </span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">welcome-file-list</span></font> <font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&lt;/</span></font><font color="#3F7F7F" face="Courier New" size="2"><span style="font-size:10pt">web-app</span></font><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#008080" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div><span style="color: rgb(227, 0, 0);">chat.html</span></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!DOCTYPE html PUBLIC</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html xmlns=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;http://www.w3.org/1999/xhtml&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">lang=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;en-US&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">xml:lang=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;en-US&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">  &lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">  &lt;!-- Chat example, adapted from jenchat: http:</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//code.jenseng.com</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    $Id: chat.html,v 1.10 2006/05/15 11:52:53 justb Exp $</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   --&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;meta http-equiv=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Content-Type&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">content=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/html; charset=utf-8&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">/&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;title&gt;Pushlet Chat&lt;/title&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;link href=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chat.css&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">rel=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;stylesheet&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;style type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/css&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/style&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;util.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;ajax-pushlet-client.js&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;script type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;!--</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      var chatDoc;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      var chatFrame;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      var nick=getPageParameter(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'anon'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      window.onload = chat_init;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function chat_init(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(window.frames &amp;&amp; window.frames[</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">])</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//IE 5 (Win/Mac), Konqueror, Safari</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">          chatFrame = window.frames[</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">];</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(document.getElementById(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).contentWindow)</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//IE 5.5+, Mozilla 0.9+, Opera</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">          chatFrame = document.getElementById(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">).contentWindow;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//Moz &lt; 0.9 (Netscape 6.0)</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">          chatFrame = document.getElementById(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">(chatFrame.document)</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//Moz 0.9+, Konq, Safari, IE, Opera</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">          chatDoc = chatFrame.document;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//Moz &lt; 0.9 (Netscape 6.0)</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">          chatDoc = chatFrame.contentDocument;</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        enterChat();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        document.forms[0].msg.focus();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Event Callback for join</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            function onJoinAck(event) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  appendMessage(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'Listening to chat'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Event Callback: display all events</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       function onData(event) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  p_debug(</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>false</b></span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;pushlet-app&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'event received event='</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.getEvent() );</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  var action = event.get(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'action'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  var content =</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'none action='</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ action;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(action ==</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'send'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        content =</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;b&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.get(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">) +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/b&gt;: &lt;i&gt;'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.get(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'msg'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;/i&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(action ==</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'enter'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        content =</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;b&gt;&lt;i&gt;*** '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.get(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">) +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' joined chat  ***&lt;/i&gt;&lt;/b&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>else</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>if</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">(action ==</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'exit'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                        content =</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'&lt;b&gt;&lt;i&gt;*** '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.get(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">) +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' left chat  ***&lt;/i&gt;&lt;/b&gt;'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        appendMessage(content);</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Event Callback: display all events</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function onNack(event) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">         alert(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'negative response from server: '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.getEvent() +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">' reason: '</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+ event.get(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'p_reason'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">));</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function appendMessage  (content){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        var newDiv = chatDoc.createElement(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;DIV&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        newDiv.innerHTML = content;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        chatDoc.getElementById(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;contents&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).appendChild(newDiv);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        chatFrame.scrollTo(0, chatDoc.getElementById(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;contents&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">).offsetHeight);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function enterChat(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            p_join_listen(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/chat'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      p_publish(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/chat'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'action'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'enter'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">, nick);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function sendMsg(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        p_publish(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/chat'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'action'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'send'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">, nick,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'msg'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">, document.getElementById(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;msg&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">).value);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        resetForm();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function leaveChat(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Send exit to chatters</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        p_publish(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/chat'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'action'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'exit'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'nick'</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">, nick);</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font><font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Stop pushlet session</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      p_leave();</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font><font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// Give some time to send the leave request to server</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      setTimeout(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'gotoEnter()'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">, 500);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     function gotoEnter() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        window.location.href=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'enter.html'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     function resetForm(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        document.forms[0].msg.value =</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        document.forms[0].msg.focus();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     }</span></font><font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//--&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">    &lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">  &lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">  &lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">   &lt;center&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     &lt;h3&gt;Pushlet Chat (AJAX Version)&lt;/h3&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     &lt;iframe id=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">name=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;chatContents&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;contents.html&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/iframe&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">        &lt;form action=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">onSubmit=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;sendMsg(); return false;&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">         &lt;input type=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">name=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;msg&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;msg&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">style=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;width: 300px&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">/&gt;&amp;nbsp;&lt;a href=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">onclick=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;javascript:leaveChat()&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;[exit]&lt;/a&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">       &lt;/form&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">     &lt;/center&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">  &lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#E30000">Moeny.java</font></div><div align="left"><div align="left"><font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">//向 /money 主题添加事件</span></font></div><div align="left"><font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Money</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>implements</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Serializable{</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>public</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>static</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>class</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">MoneyTest</span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>extends</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">EventPullSource {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>private</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>int</b></span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>long</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">getSleepTime() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>return</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">10000;</span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 10秒</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font color="#010101" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#646464" face="Courier New" size="2"><span style="font-size:10pt">@Override</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>protected</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">Event pullEvent() {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 用来向主题添加事件</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  System.</span></font> <font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt"><i>out</i></span></font><font face="Courier New" size="2"><span style="font-size:10pt">.println(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;------- &quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font><font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 创建/money 主题相关事件</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  Event event  = Event.</span> <span style="font-size:10pt"><i>createDataEvent</i></span><span style="font-size:10pt">(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;/money&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 设置事件参数  name value ，客户端通过name 获得 value</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  event.setField(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testName&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">,</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testValue&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">+</span></font><font color="#0000C0" face="Courier New" size="2"><span style="font-size:10pt">i</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">++);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">                  </span></font> <font color="#7F0055" face="Courier New" size="2"><span style="font-size:10pt"><b>return</b></span></font> <font face="Courier New" size="2"><span style="font-size:10pt">event;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">}</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><font color="#E30000">demo.html</font></div><div align="left"><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;meta http-equiv=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;Content-Type&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">content=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/html; charset=UTF-8&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;title&gt;编写最简单 pushlet demo&lt;/title&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;ajax-pushlet-client.js&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;!-- pushlet框架本身 不依赖 jQuery --&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">src=</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;jquery-1.8.3.js&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;script type=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;text/javascript&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      $(function(){</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            alert(1);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 初始化 pushlet 客户端对象</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            PL._init();</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// pushlet框架 采用观察者模式</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            PL.joinListen(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">'/money'</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 服务器只要有 和 /money相关的信息，主动发给客户端</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      });</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      </span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      function onData(event) {</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            alert(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;ok&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            </span></font> <font color="#3F7F5F" face="Courier New" size="2"><span style="font-size:10pt">// 获得服务器发回数据</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            var value = event.get(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;testName&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">            $(</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#info&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">).html($(</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;#info&quot;</span></font> <font face="Courier New" size="2"><span style="font-size:10pt">).html() + value +</span></font> <font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;&lt;br/&gt;&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">);</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">      }</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/script&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/head&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;div id=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">&quot;info&quot;</span></font><font face="Courier New" size="2"><span style="font-size:10pt">&gt;&lt;/div&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/body&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">&lt;/html&gt;</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><div><span style="color: rgb(227, 0, 0);">sources.properties</span></div></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source1=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$TemperatureEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source2=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$SystemStatusEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source3=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$PushletStatusEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source4=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$AEXStocksEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source5=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$WebPresentationEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source6=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">nl.justobjects.pushlet.test.TestEventPullSources$PingEventPullSource</span></font></div><div align="left"><font face="Courier New" size="2"><span style="font-size:10pt">source7=</span></font><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt">app.pushlet.Money$MoneyTest</span></font></div><div align="left"><font color="#2A00FF" face="Courier New" size="2"><span style="font-size:10pt"><br></span></font></div><div align="left"><img src="反向Ajax_files/Image [3].png" type="image/png" style="cursor: default;"/></div><div align="left"><img src="反向Ajax_files/Image [4].png" type="image/png" style="cursor: default;"/></div><div align="left"><br></div><div align="left"><img src="反向Ajax_files/Image [5].png" type="image/png" style="cursor: default;"/></div><div align="left"><br></div></div></div></div></div></div></div></div>
</div></body></html> 